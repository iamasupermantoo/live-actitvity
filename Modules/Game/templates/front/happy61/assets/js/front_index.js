requirejs.config({baseUrl:".",paths:{jquery:"/assets/js/jquery-3.3.1.min",hotkeys:"/wall/themes/meepo/assets/plugs/hotkeys-master/dist/hotkeys.min",bindhotkeys:"/wall/themes/meepo/assets/js/bindhotkeys",},shim:{bindhotkeys:{deps:["hotkeys"]}}});requirejs(["jquery","bindhotkeys"],function($){window.getdatatimer=null;var gamestarted_at=0;var timepercent=0;var round_welcome_elm=$(".welcome_box");$(document).ready(function(){if(!GAMECONFIG){alert("后台没有设置游戏,请先设置一轮游戏哦");return}initNavBar();getData();checkingStatus()});function renderStartPage(){var qrcode=$(window.top.document).find("#box img").attr("src");qrcode=qrcode.replace("./","/");qrcode=qrcode.trim();round_welcome_elm.find("img.qrimg").attr("src",qrcode);round_welcome_elm.slideDown()}function renderJoinCounter(num){$(".main_right .joinNum").html(""+num+"人")}radarusers=[];radaruserindex=0;function renderRadar(){if(radarusers.length<=0){return}$("#Audio_NewPlayer")[0].play();var user=radarusers.shift();var userhtml='<img class="avatar default" src="'+user.avatar+'">';if($(".avatar.default").length>10){$(".avatar.default").eq(0).animate({opacity:0},1000,function(){$(this).remove();$(userhtml).appendTo(".list").animate({opacity:0.7},500)})}else{$(".avatar.default").eq(radaruserindex).attr("src",user.avatar)}radaruserindex++}laststatus=0;function showStartPage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;renderStartPage()}radarusers=radarusers.concat(users.userlist);renderJoinCounter(users.num);renderRadar()}function hideStartPage(){round_welcome_elm.slideUp()}function showGamePage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;hideStartPage();initNavBar();Track.resize()}if(GAMECONFIG.themeconfig.durationtype==1){gamestarted_at=gamestarted_at==0?Math.round((new Date().getTime())/1000):gamestarted_at;var now=Math.round((new Date().getTime())/1000);var timepassed=now-gamestarted_at;timepercent=timepercent>=1?1:timepassed/GAMECONFIG.themeconfig.duration}else{timepercent=1}if(users){for(var i=0,l=users.length;i<l;i++){Track.showprogress(i,users[i]);maxpoints=maxpoints>parseInt(users[i]["point"])?maxpoints:parseInt(users[i]["point"])}}if(GAMECONFIG.themeconfig.durationtype==1){if(timepercent==1){stopGame()}}else{if(parseInt(maxpoints)>=parseInt(GAMECONFIG.themeconfig.duration)){stopGame()}}}function showEndPage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;EndPage.show(users)}}function checkingStatus(){var state=window.sessionStorage["game"];if(state=="start"){window.sessionStorage["game"]="idle";startGame()}if(state=="reset"){window.sessionStorage["game"]="idle";resetGame()}setTimeout(checkingStatus,500)}function startGame(){ajaxPostData("start").done(function(json){showGamePage()})}function resetGame(){ajaxPostData("reset").done(function(json){clearTimeout(getdatatimer);getdatatimer=null;alert(json.message);if(json.code>0){setTimeout(function(){window.location.reload()},3000)}})}function stopGame(){ajaxPostData("stop").done(function(json){if(json.code<0){alert(json.message)}})}function getData(){ajaxGetData().done(function(json){if(json.code>0){GAMECONFIG.status=json.config.status;if(json.config.status==1){showStartPage(json.users);getdatatimer=setTimeout(getData,1000)}if(json.config.status==2){getdatatimer=setTimeout(getData,1000);showGamePage(json.users)}if(json.config.status==3){showEndPage(json.users)}return}}).fail(function(){alert("您的网络不稳定,点确定后,系统会重新连接,如果再次弹出这个提示,请检查网络,或者更换网络");clearTimeout(getdatatimer);getdatatimer=setTimeout(getData,1000)})}var ajaxGetData=function(){return $.ajax({"url":"/Modules/module.php?m=game&c=front&a=ajaxGetData","type":"get","dataType":"json",})};var ajaxPostData=function(action){return $.ajax({"url":"/Modules/module.php?m=game&c=front&a=ajaxPostData","type":"post","dataType":"json","data":{"action":action}})};function initNavBar(){var opts={};if(GAMECONFIG.status==1){opts.btn_start=function(){window.sessionStorage["game"]="start"}}if(GAMECONFIG.status==2||GAMECONFIG.status==3){opts.btn_reset=function(){window.sessionStorage["game"]="reset"}}window.top.minibar.init(opts);window.sessionStorage["bgmusic"]=GAMECONFIG.themeconfig.bgmusic_path+"|"+GAMECONFIG.themeconfig.bgmusic_switch;if(CONFIGS.length>0){var btns=[];var icons=["iconyyy","iconxqc","iconhzsq","iconsq","iconjzsf","iconsaipao","iconslz","iconsc","iconsm","iconst","iconqbtzj","icon61"];var themename=["iconyyy","默认汽车","猴子爬树","数钱游戏","金猪送福","赛跑","赛龙舟","赛车","赛马","游艇","丘比特之箭","欢乐六一"];for(var i=0,l=CONFIGS.length;i<l;i++){var iscurrent=GAMECONFIG.id==CONFIGS[i]["id"]?1:2;btns[i]={"name":themename[CONFIGS[i]["themeid"]],"action":"/Modules/module.php?m=game&c=front&a=index&id="+CONFIGS[i]["id"],"icon":icons[CONFIGS[i]["themeid"]],"current":iscurrent}}window.top.roundbar().init(btns)}}var maxpoints=0;var Track={"tracklist_elm":null,"track_elm":null,"width":0,"height":0,"size":0,"init":function(){if(this.tracklist_elm==null){this.tracklist_elm=$(".tracklist")}this.height=(this.tracklist_elm.height()/10);this.width=(this.tracklist_elm.width()-this.height);
this.size=this.height>this.width?this.width:this.height},"resize":function(){this.init();var self=this;var html="";for(var i=0;i<10;i++){html+='<div class="trackline" style="display: block; height: '+self.height+"px; line-height: "+self.height+"px; font-size: "+self.height/2+'px;">';html+='<div class="track-start" style="width: '+self.height+"px; height: "+self.height+'px;">'+(i+1)+"</div>";html+='<div class="track-end" style="width:6px; height: '+self.height+'px;"></div>';html+="</div>"}$(".tracklist").append(html);var player="";for(var i=0;i<10;i++){player+='<div class="player player'+i+'" style="top:'+((i+1)*self.height)+'px;">';player+='<div class="yyytp">';player+='<img class="yyyimg" src="/Modules/Game/templates/front/happy61/assets/images/avatar.gif" />';player+='<div class="lunzia car'+i+' okplay"></div>';player+='<div class="lunzib car'+i+' okplay"></div>';player+="</div>";player+='<div class="pnctx">';player+="<div class='head shake' style='background-image: url(/Modules/Game/templates/front/happy61/assets/images/default.png)'></div>";player+='<div class="nickname">选手'+(i+1)+"号</div>";player+="</div>";player+="</div>"}$(".tracklist").append(player);$(".track-end").show();$(".paomabeijing2,.paomabeijing,.tracklist,.player .lunzia,.player .lunzib").removeClass("okplay");$(".paomabeijing2,.paomabeijing,.tracklist,.player .lunzia,.player .lunzib").addClass("okplay")},"ph_arr":[],"oldprogress":[],"showprogress":function(index,player){if(this.oldprogress[index]==undefined){this.oldprogress[index]=0}var progress=this.calcProgress(player["point"]);if(this.tracklist_elm==null){this.resize()}var p=$(".player"+index);p.css("left",progress+"%");p.find(".head").css({"background-image":"url("+player["avatar"]+")"});p.find(".nickname").text(player["nickname"])},"maxpoint":0,"calcProgress":function(point){if(GAMECONFIG.themeconfig.durationtype==1){this.maxpoint=this.maxpoint>parseInt(point)?this.maxpoint:parseInt(point);var percent=Math.round(point/this.maxpoint*timepercent*100);console.warn("point:"+point+" maxpoint:"+this.maxpoint+" percent:"+timepercent);return percent}else{var percent=Math.round(point/GAMECONFIG.themeconfig.duration*100);return percent>=100?100:percent}}};var EndPage={"result_layer":null,"result_label":null,"result_cap":null,"player_tp":$("<div class='player'><div class='head'></div><div class='nickname'></div></div>"),"showGameoverPage":function(){$(".paomabeijing2,.paomabeijing,.tracklist,.player .lunzia,.player .lunzib").removeClass("okplay");this.result_layer.show().animateControl("bounceIn");$("#Audio_Gameover")[0].play()},"show":function(users){var self=this;this.result_layer=$(".rank_box");winner_num=users.num;if(users.num>10){setTimeout(function(){self.showScore()},1000);return}this.showGameoverPage();showrank(users.users);function showrank(users){var usernum=users.length;if(usernum>=1&&users[0]){var rank=$(".rank1");rank.find("img").attr("src",users[0]["avatar"]);rank.find("p").text(users[0]["nickname"])}if(usernum>=2&&users[1]){var rank=$(".rank2");rank.find("img").attr("src",users[1]["avatar"]);rank.find("p").text(users[1]["nickname"])}if(usernum>=3&&users[2]){var rank=$(".rank3");rank.find("img").attr("src",users[2]["avatar"]);rank.find("p").text(users[2]["nickname"])}if(usernum>3){var rank_others=$(".rank_others").find("li");for(var i=3,l=usernum;i<l;i++){$(rank_others[i-3]).find(".avarta").attr("src",users[i]["avatar"]);$(rank_others[i-3]).find("p").text(users[i]["nickname"])}}}},"showScore":function(){var url="/Modules/module.php?m=game&c=front&a=gameResult";showPage(url)}};showPage=function(c){var d=$('<div class="frame-dialog"><div class="phbphb" id="phbphb"><img src="/Modules/Game/templates/front/racing/assets/images/phb.png" class="phbtop" ><div class="phbk"><div class="phbbiaok"><iframe frameborder="0" src="'+c+'"></iframe></div></div></div></div>');d.css({"z-index":999});d.appendTo("body").show()};(function($){$.fn.extend({animateControl:function(a,fn){this.addClass("animated "+a).one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){if(fn){fn()}$(this).removeClass("animated "+a)});return this}})})(jQuery)});