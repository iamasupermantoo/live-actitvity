requirejs.config({baseUrl:".",paths:{jquery:"/assets/js/jquery-3.3.1.min",hotkeys:"/wall/themes/meepo/assets/plugs/hotkeys-master/dist/hotkeys.min",bindhotkeys:"/wall/themes/meepo/assets/js/bindhotkeys",},shim:{bindhotkeys:{deps:["hotkeys"]}}});requirejs(["jquery","bindhotkeys"],function($){window.getdatatimer=null;var gamestarted_at=0;var timepercent=0;var round_welcome_elm=$(".round-welcome");$(document).ready(function(){if(!GAMECONFIG){alert("后台没有设置游戏,请先设置一轮游戏哦");return}initNavBar();getData();checkingStatus()});function renderStartPage(){var qrcode=$(window.top.document).find("#box img").attr("src");qrcode=qrcode.replace("./","/");qrcode=qrcode.trim();round_welcome_elm.find("img.qr").attr("src",qrcode);round_welcome_elm.slideDown()}function renderJoinCounter(num){$(".round-label2 span").html("<i>"+num+"</i>").find("i").toggleClass("animate-rotate2")}radarusers=[];radaruserindex=0;function renderRadar(){if(radarusers.length<=0){return}radaruserindex++;$("#Audio_NewPlayer")[0].play();var user=radarusers.shift();var userhtml='<div id="shake_user_'+radaruserindex+'" class="user-item"><div class="user-img"><img src="'+user.avatar+'" /></div><p></p></div>';if($(".user-item").length>9){$(".user-item").eq(0).animate({opacity:0},1000,function(){$(this).remove();$(userhtml).appendTo(".users").animate({opacity:0.7},500)})}else{$(userhtml).appendTo(".users").animate({opacity:0.7},500)}}laststatus=0;function showStartPage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;renderStartPage()}radarusers=radarusers.concat(users.userlist);renderJoinCounter(users.num);renderRadar()}function hideStartPage(){round_welcome_elm.slideUp()}function showGamePage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;hideStartPage();initNavBar();Track.resize()}if(GAMECONFIG.themeconfig.durationtype==1){gamestarted_at=gamestarted_at==0?Math.round((new Date().getTime())/1000):gamestarted_at;var now=Math.round((new Date().getTime())/1000);var timepassed=now-gamestarted_at;timepercent=timepercent>=1?1:timepassed/GAMECONFIG.themeconfig.duration}else{timepercent=1}if(users){for(var i=0,l=users.length;i<l;i++){Track.showprogress(i,users[i]);maxpoints=maxpoints>parseInt(users[i]["point"])?maxpoints:parseInt(users[i]["point"])}}if(GAMECONFIG.themeconfig.durationtype==1){if(timepercent==1){stopGame()}}else{if(parseInt(maxpoints)>=parseInt(GAMECONFIG.themeconfig.duration)){stopGame()}}}function showEndPage(users){if(laststatus!=GAMECONFIG.status){laststatus=GAMECONFIG.status;EndPage.show(users)}}function checkingStatus(){var state=window.sessionStorage["game"];if(state=="start"){window.sessionStorage["game"]="idle";startGame()}if(state=="reset"){window.sessionStorage["game"]="idle";resetGame()}setTimeout(checkingStatus,500)}function startGame(){ajaxPostData("start").done(function(json){showGamePage()})}function resetGame(){ajaxPostData("reset").done(function(json){clearTimeout(getdatatimer);getdatatimer=null;alert(json.message);if(json.code>0){setTimeout(function(){window.location.reload()},3000)}})}function stopGame(){ajaxPostData("stop").done(function(json){if(json.code<0){alert(json.message)}})}function getData(){ajaxGetData().done(function(json){if(json.code>0){GAMECONFIG.status=json.config.status;if(json.config.status==1){showStartPage(json.users);getdatatimer=setTimeout(getData,1000)}if(json.config.status==2){getdatatimer=setTimeout(getData,1000);showGamePage(json.users)}if(json.config.status==3){showEndPage(json.users)}return}}).fail(function(){alert("您的网络不稳定,点确定后,系统会重新连接,如果再次弹出这个提示,请检查网络,或者更换网络");clearTimeout(getdatatimer);getdatatimer=setTimeout(getData,1000)})}var ajaxGetData=function(){return $.ajax({"url":"/Modules/module.php?m=game&c=front&a=ajaxGetData","type":"get","dataType":"json",})};var ajaxPostData=function(action){return $.ajax({"url":"/Modules/module.php?m=game&c=front&a=ajaxPostData","type":"post","dataType":"json","data":{"action":action}})};function initNavBar(){var opts={};if(GAMECONFIG.status==1){opts.btn_start=function(){window.sessionStorage["game"]="start"}}if(GAMECONFIG.status==2||GAMECONFIG.status==3){opts.btn_reset=function(){window.sessionStorage["game"]="reset"}}window.top.minibar.init(opts);window.sessionStorage["bgpath"]=GAMECONFIG.themeconfig.bg_path;window.sessionStorage["bgmusic"]=GAMECONFIG.themeconfig.bgmusic_path+"|"+GAMECONFIG.themeconfig.bgmusic_switch;if(CONFIGS.length>0){var btns=[];var icons=["iconyyy","iconxqc","iconhzsq","iconsq","iconjzsf","iconsaipao","iconslz","iconsc","iconsm","iconst","iconqbtzj","icon61"];var themename=["iconyyy","默认汽车","猴子爬树","数钱游戏","金猪送福","赛跑","赛龙舟","赛车","赛马","游艇","丘比特之箭","欢乐六一"];for(var i=0,l=CONFIGS.length;i<l;i++){var iscurrent=GAMECONFIG.id==CONFIGS[i]["id"]?1:2;btns[i]={"name":themename[CONFIGS[i]["themeid"]],"action":"/Modules/module.php?m=game&c=front&a=index&id="+CONFIGS[i]["id"],"icon":icons[CONFIGS[i]["themeid"]],"current":iscurrent}}window.top.roundbar().init(btns)}}var maxpoints=0;var Track={"tracklist_elm":null,"track_elm":null,"width":0,"height":0,"size":0,"init":function(){if(this.tracklist_elm==null){this.tracklist_elm=$(".Panel.Track .tracklist");
this.track_elm=this.tracklist_elm.children()}this.height=(this.tracklist_elm.height()/10);this.width=(this.tracklist_elm.width()-this.height);this.size=this.height>this.width?this.width:this.height;var endline_css=null;var startline_css=null;var trackodd_css=null;startline_css={"background":"url("+GAMECONFIG.themeconfig.startline_path+") repeat-y left center","background-size":"10px auto"};endline_css={"background":"url("+GAMECONFIG.themeconfig.endline_path+") repeat-y center center","background-size":"45px auto;"};trackodd_css={"background":"url("+GAMECONFIG.themeconfig.oddtrack_path+") repeat"};trackeven_css={"background":"url("+GAMECONFIG.themeconfig.eventrack_path+") repeat"};$(".yyycj .paoma .xxx").css(startline_css);$(".yyycj .zd").css(endline_css);$(".yyycj ul li").css(trackodd_css);$(".yyycj ul li:nth-child(2n)").css(trackeven_css)},"resize":function(){this.init();var self=this;$(".Panel .Track").show();this.track_elm.each(function(){$(this).css({height:self.height,"line-height":self.size+"px","font-size":self.size*3/5+"px"}).find(".ma").css({"width":"0px","height":"100%",});$(this).find(".tutu").css({"width":"0px","height":"100%",})})},"ph_arr":[],"oldprogress":[],"showprogress":function(index,player){if(this.oldprogress[index]==undefined){this.oldprogress[index]=0}var progress=this.calcProgress(player["point"]);if(this.tracklist_elm==null){this.resize()}if(this.ph_arr[index]==undefined){this.ph_arr[index]=$("#ph"+index)}var ph=this.ph_arr[index];var nicheng=$("#nc"+index,ph);nicheng.html(player["nickname"]);var symbol=$("#symbol"+index,ph);symbol.attr("src",GAMECONFIG.themeconfig["avatar_"+index+"_path"]);var tx=$("#tx"+index,ph);if(index<3&&progress>=100){tx.attr("src","/Modules/Game/templates/front/racing/assets/images/p"+index+".jpg")}else{tx.attr("src",player["avatar"])}ph_css={"width":progress+"%","margin-top":"-"+this.size/2+"px"};symbol_css={"max-height":this.size+"px"};symbol.css(symbol_css);var touxiang_shift=(symbol.width()+4);var nicheng_shift=touxiang_shift+(tx.width()+4);tx.css({"right":touxiang_shift+"px"});nicheng.css({"right":nicheng_shift+"px"});if(progress>this.oldprogress[index]){ph.animate(ph_css,1000);$("#pxh"+index).animate(ph_css,1000);this.oldprogress[index]=progress}},"maxpoint":0,"calcProgress":function(point){if(GAMECONFIG.themeconfig.durationtype==1){this.maxpoint=this.maxpoint>parseInt(point)?this.maxpoint:parseInt(point);var percent=Math.round(point/this.maxpoint*timepercent*100);console.warn("point:"+point+" maxpoint:"+this.maxpoint+" percent:"+timepercent);return percent}else{var percent=Math.round(point/GAMECONFIG.themeconfig.duration*100);return percent>=100?100:percent}}};var EndPage={"result_layer":null,"result_label":null,"result_cap":null,"player_tp":$("<div class='player'><div class='head'></div><div class='nickname'></div></div>"),"showGameoverPage":function(){this.result_layer.show();this.result_label.show().addClass("pulse");this.result_cup.hide();$("#Audio_Gameover")[0].play()},"show":function(users){var self=this;this.result_layer=$(".result-layer");this.result_label=$(".result-label",this.result_layer);this.result_cup=$(".result-cup",this.result_layer);winner_num=users.num;this.showGameoverPage();if(users.num>3){setTimeout(function(){self.showScore()},3000);return}showrank(users.users);function showrank(users){window.setTimeout(function(){self.result_label.fadeOut(function(){self.result_cup.show(function(){if(winner_num>=1&&users[0]){window.setTimeout(function(){var e=self.player_tp.clone().addClass("result").css({left:"50%","margin-left":"-65px",width:"160px",height:"160px",bottom:"150px"});e.find(".head").css({"background-image":"url("+users[0]["avatar"]+")"}).addClass("shake");e.find(".nickname").html(users[0]["nickname"]);e.appendTo(self.result_cup).addClass("bounce");console.log("1")},800)}if(winner_num>=2&&users[1]){window.setTimeout(function(){var e=self.player_tp.clone().addClass("result").css({left:"40px",width:"100px",height:"100px",bottom:"120px"});e.find(".head").css({"background-image":"url("+users[1]["avatar"]+")"}).addClass("shake");e.find(".nickname").html(users[1]["nickname"]);e.appendTo(self.result_cup).addClass("bounce");console.log("2")},1800)}if(winner_num>=3&&users[2]){window.setTimeout(function(){var e=self.player_tp.clone().addClass("result").css({right:"30px",width:"70px",height:"70px",bottom:"100px"});e.find(".head").css({"background-image":"url("+users[2]["avatar"]+")"}).addClass("shake");e.find(".nickname").html(users[2]["nickname"]);e.appendTo(self.result_cup).addClass("bounce");console.log("3")},2800)}})}).removeClass("pulse")},1000)}},"showScore":function(){var url="/Modules/module.php?m=game&c=front&a=gameResult";showPage(url)}};showPage=function(c){var d=$('<div class="frame-dialog"><div class="phbphb" id="phbphb"><img src="/Modules/Game/templates/front/racing/assets/images/phb.png" class="phbtop" ><div class="phbk"><div class="phbbiaok"><iframe frameborder="0" src="'+c+'"></iframe></div></div></div></div>');d.css({"z-index":999});
d.appendTo("body").show()}});