var index=function(){function q(a){d=prizesdata[a];$("#prizedata").text(d.prizename);$(".lottery-img").find("img").attr("src",d.formatedtext.text);D(d.id)}function D(a){$(".lottery-win-scroll").html("");$.ajax({url:"/Modules/module.php?m=lottery&c=front&a=ajaxGetWinners",data:{activityid:configid,prizeid:a},type:"post",dataType:"json"}).done(function(a){if(0>a.code)return alert(a.message),!1;r=a.data.participants;if(0<a.data.winners.length){var b="";n=a.data.winners.length;for(var e=0;e<n;e++)b+=
v(a.data.winners[e]);$(b).appendTo($(".lottery-win-scroll"));$(".winner-name").css({color:g.winnerfontcolor});$(".winnernum_txt").text(n)}})}function w(a){n++;a=v(a);$(a).prependTo($(".lottery-win-scroll"));$(".winner-name").css({color:g.winnerfontcolor});$(".winnernum_txt").text(n)}function v(a){var b='<li><div class="lottery-avatar-bd"><div class="lottery-avatar-bg">{{image}}</div></div><div class="winner-name">{{col1}}</div></li>';b=""!=a.nick_name?b.replace("{{col1}}",""+a.nick_name):b.replace("{{col1}}",
"");return b=void 0!=a.avatar&&""!=a.avatar?b.replace("{{image}}",'<img src="'+a.avatar+'">'):b.replace("{{image}}",'<img src="/Modules/Lottery/templates/front/threedimensional/assets/images/avatar-primary.png">')}function x(){h=(h+1)%t;c=1;l.text(c);q(h)}function y(){h=0>h-1?t-1:h-1;h%=t;c=1;l.text(c);q(h)}function z(){c--;c=1>c?1:c;l.text(c)}function A(){if(0>r-c)return alert("\u5df2\u7ecf\u6ca1\u6709\u53ef\u4ee5\u53c2\u4e0e\u62bd\u5956\u7684\u4eba\u4e86\u3002"),!1;if(0>d.totalleft-c)return alert("\u5956\u54c1\u6570\u91cf\u4e0d\u591f\u4e86\uff0c\u65e0\u6cd5\u8fdb\u884c\u62bd\u5956\u3002"),
!1;if(1==p)return!1;k.find(".lottery-right").hide();k.find(".btn-start");f.removeClass("btn-start").addClass("btn-stop");f.off("click");f.hide();$.ajax({url:"/Modules/module.php?m=lottery&c=front&a=ajaxGetTempUsers",type:"get",dataType:"json"}).done(function(a){0<a.code&&(B=a.data,a=E(B),startanimate(a,g.showstyle),setTimeout(function(){p=!0;f.show();f.on("click",function(){F()})},2E3))})}function E(a){var b=[],c=a.length;if(!(0>=c)){for(var e=0;126>e;e++)b[e]={},b[e]=a[e%c],b[e].src=a[e%c].thumb_image,
b[e].p_x=e%20+1,b[e].p_y=Math.floor(e/20)+1;return b=b.sort(function(){return Math.random()})}}function F(){if(0>r-c)return alert("\u5df2\u7ecf\u6ca1\u6709\u53ef\u4ee5\u53c2\u4e0e\u62bd\u5956\u7684\u4eba\u4e86\u3002"),!1;if(0>d.totalleft-c)return alert("\u5956\u54c1\u6570\u91cf\u4e0d\u591f\u4e86\uff0c\u65e0\u6cd5\u8fdb\u884c\u62bd\u5956\u3002"),!1;if(0==p)return!1;f.removeClass("btn-stop").addClass("btn-start");f.off("click");$.ajax({url:"/Modules/module.php?m=lottery&c=front&a=ajaxGetLotteryResult",
data:{activityid:configid,prizeid:d.id,num:c},type:"post",dataType:"json"}).done(function(a){0<a.code?(restartanimate(),k.find(".lottery-right").show(),m=m.concat(a.data),d.totalleft-=a.data.length,G(),f.on("click",function(){A()})):(alert(a.message),window.location.reload())})}function G(){5<m.length?(H(m),m=[]):C(m,function(a){w(a)},function(){p=!1})}function H(a){var b=u.find(".group-bar ul");b.html("");for(var c="",e=0,g=a.length;e<g;e++){var f=a[e],d='<li><div class="winner-avatar"><div class="avatar-box">{{image}}</div></div><span class="winner-name">{{col1}}</span></li>';
d=""!=f.nick_name?d.replace("{{col1}}",""+f.nick_name):d.replace("{{col1}}","");d=void 0!=f.avatar&&""!=f.avatar?d.replace("{{image}}",'<img src="'+f.avatar+'">'):d.replace("{{image}}","");c=d+c;w(a[e])}$(c).prependTo(b);u.show()}function C(a,c,d){if(0>=a.length)d();else{var e=a.pop(),b=$(".winner-single-pop");b.find(".avatar-contain img").attr("src",e.avatar);b.find(".winer-name").text(e.nick_name);b.css({opacity:0});b.show();b.animate({opacity:1},1E3,function(){b.fadeOut(1E3,function(){c(e);C(a,
c,d)})})}}function I(){console.log("bind btns");J.on("click",function(){y()});K.on("click",function(){x()});L.on("click",function(){z()});M.on("click",function(){c++;l.text(c)});f.on("click",function(){A()});N.on("click",function(){u.hide();p=!1})}function O(){hotkeys("up",function(a){c++;l.text(c)});hotkeys("down",function(a){z()});hotkeys("left",function(a){y()});hotkeys("right",function(a){x()});hotkeys("space",function(a){f.trigger("click")})}var k=$("#lottery-panel"),J=k.find(".btn-left"),K=
k.find(".btn-right"),L=k.find(".icon-minus"),M=k.find(".icon-plus"),f=k.find(".btn-start"),N=$(".winner-group-pop").find(".btn-pop-close"),l=k.find(".lottery-num"),u=$(".winner-group-pop"),c=0,h=0,d=null,t=prizesdata.length,B=[],n=0,r=0,g=lotteryconfig.themeconfig,p=!1,m=[];return{init:function(){if(0>=prizesdata.length)alert("\u8bf7\u5148\u5728\u540e\u53f0\u6dfb\u52a0\u5956\u9879,\u7136\u540e\u5237\u65b0\u9875\u9762\u54e6!");else{for(var a=0,b=prizesdata.length;a<b;a++)prizesdata[a].totalleft=parseInt(prizesdata[a].leftnum)+
parseInt(prizesdata[a].freezenum);c=parseInt(l.text());q(h)}I();O();$(".lottery-left").css({"background-color":g.leftcolor});$(".lottery-right").css({"background-color":g.rightcolor});$(".prizename,.control-item,.winnernum").css({color:g.fontcolor});$(".winner-name").css({color:g.winnerfontcolor});$("#prizedata").css({color:g.prizefontcolor});window.sessionStorage.bgpath=g.bg_path;window.sessionStorage.bgmusic=g.bgmusic_path+"|"+g.bgmusic_switch;if(0<lotteryconfigs.length){a=[];b=["","icon3dcj","iconzjd",
"iconcjx"];for(var d=0,e=lotteryconfigs.length;d<e;d++)a[d]={name:lotteryconfigs[d].title,action:"/Modules/module.php?m=lottery&c=front&a=index&id="+lotteryconfigs[d].id,icon:b[lotteryconfigs[d].themeid],current:configid==lotteryconfigs[d].id?1:2};window.top.roundbar().init(a)}}}}();$(document).ready(function(){index.init()});